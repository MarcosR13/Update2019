Sub MelhorCustoTodasLinhas()

    Dim wsPainel As Worksheet
    Dim wsDados As Worksheet
    Dim custo As Double
    Dim i As Long
    Dim lastRow As Long
    Dim criterios As String
    Dim criterio1 As Boolean
    Dim criterio2 As Boolean
    Dim criterio3 As Boolean
    Dim criterio4 As Boolean
    Dim criterio5 As Boolean
    Dim criterio6 As Boolean
    
    Set wsPainel = ThisWorkbook.Sheets("Painel")
    Set wsDados = ThisWorkbook.Sheets("Dados") ' Ajuste o nome da planilha conforme necessário

    ' Define os critérios com base nas seleções do Painel
    criterio1 = wsPainel.Range("$C$7").Value
    criterio2 = wsPainel.Range("$C$3").Value
    criterio3 = wsPainel.Range("$C$4").Value
    criterio4 = wsPainel.Range("$C$5").Value
    criterio5 = wsPainel.Range("$C$6").Value
    criterio6 = wsPainel.Range("$C$2").Value
    
    ' Descobre a última linha preenchida na coluna A da planilha de dados
    lastRow = wsDados.Cells(wsDados.Rows.Count, "A").End(xlUp).Row

    ' Loop pelas linhas da aba Dados
    For i = 2 To lastRow ' Assume que a primeira linha são cabeçalhos

        ' Reseta os critérios para cada linha
        criterios = ""
        
        ' Constrói os critérios dinâmicos para a fórmula
        If criterio1 Then
            criterios = "D:D=D" & i & ", E:E=E" & i
        End If
        If criterio2 Then
            If criterios <> "" Then criterios = criterios & " And "
            criterios = criterios & "B:B=B" & i
        End If
        If criterio3 Then
            If criterios <> "" Then criterios = criterios & " And "
            criterios = criterios & "A:A=""LICANIA"""
        End If
        If criterio4 Then
            If criterios <> "" Then criterios = criterios & " And "
            criterios = criterios & "A:A=""NASSAU"""
        End If
        If criterio5 Then
            If criterios <> "" Then criterios = criterios & " And "
            criterios = criterios & "A:A=A" & i
        End If
        If criterio6 Then
            If criterios <> "" Then criterios = criterios & " And "
            criterios = criterios & "C:C=C" & i
        End If
        
        On Error GoTo ErrHandler
        
        ' Aplica a função MinIfs para encontrar o menor custo baseado nos critérios para a linha atual
        custo = Application.WorksheetFunction.MinIfs(wsDados.Range("G:G"), _
                                                    wsDados.Range("D:D"), wsDados.Range("D" & i), _
                                                    wsDados.Range("E:E"), wsDados.Range("E" & i), _
                                                    wsDados.Range("B:B"), wsDados.Range("B" & i), _
                                                    wsDados.Range("A:A"), wsDados.Range("A" & i), _
                                                    wsDados.Range("C:C"), wsDados.Range("C" & i))
        
        On Error GoTo 0
        
        ' Insere o valor do custo na coluna desejada (por exemplo, coluna H)
        If custo = 0 Then
            wsDados.Cells(i, "H").Value = "Melhor Custo"
        Else
            wsDados.Cells(i, "H").Value = custo
        End If
    
    Next i
    
    Exit Sub

ErrHandler:
    wsDados.Cells(i, "H").Value = "'*'"

End Sub
